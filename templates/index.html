<!DOCTYPE html>
<html lang="en">
<head>
    <title>Internal Website Pro Amity Corporate Sdn Bhd</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style/styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
    </script>
</head>
<body>
    <header>
        <div class="header-logo">
            <img src="{{ url_for('static', filename='icons/proamity-logo.png') }}" alt="Company Logo" class="logo">
        </div>
        <div class="header-title">
            <h1>Library</h1>
            <p class="confidential-message">Confidential Notice:  
                The content and documents on this website are confidential and legally privileged, 
                intended exclusively for the designated individual or entity. Unauthorized access, 
                disclosure, or distribution is strictly prohibited. If you have accessed this information 
                unintentionally, please stop immediately and notify the administrator.</p>
        </div>
        <div class="header-buttons">
            {% if current_user.role_id == 1 %}
                <a href="{{ url_for('admin_dashboard') }}" class="dashboard-button">Admin Dashboard</a>
            {% endif %}
            <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
        </div>
    </header>
    
    <div class="container">
        <aside class="sidebar">
            {% for department, folders in pdf_structure.items() %}
                <div class="department-container">
                    <h2 class="department-heading">{{ department }}</h2>
                    {% if current_user.role_id == 1 %}
                        <span class="dept-icons">
                            <img src="{{ url_for('static', filename='icons/add-folder.png') }}" onclick="addFolder('{{ department }}')" class="add-folder-icon" alt="Add Folder">
                        </span>
                    {% endif %}
                </div>
    
                {% for folder, pdffiles in folders.items() %}
                    <div class="folder-container">
                        <span class="folder-icon">
                            <img src="{{ url_for('static', filename='icons/folder.png') }}" alt="Folder Icon">
                        </span>
                        <span class="folder-name">{{ folder }}</span>
                        <span class="folder-icons">
                            {% if current_user.role_id == 1 %}
                                <img src="{{ url_for('static', filename='icons/add-file.png') }}" onclick="addPDF('{{ folder }}')" class="add-pdf-icon" alt="Add PDF">
                                <img src="{{ url_for('static', filename='icons/edit.png') }}" onclick="editFolderPrompt('{{ folder }}')" class="edit-folder-icon" alt="Edit">
                                <img src="{{ url_for('static', filename='icons/delete.png') }}" onclick="deleteFolder('{{ folder }}')" class="delete-icon" alt="Delete">
                            {% endif %}
                        </span>
                    </div>
                    <ul>
                        {% for pdf in pdffiles %}
                            <li class="pdf-item">
                                <a href="#" onclick="loadPDF('{{ folder }}/{{ pdf }}'); return false;">{{ pdf }}</a>
                                {% if current_user.role_id == 1 %}
                                    <img src="{{ url_for('static', filename='icons/delete.png') }}" onclick="deletePDF('{{ folder }}', '{{ pdf }}')" class="delete-pdf-icon" alt="Delete">
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% endfor %}
            {% endfor %}
        </aside>

        <main class="pdf-viewer-container">
            <div id="welcome-message">
                <h2>Welcome to Pro Amity Corporate Internal Website</h2>
                <p>Select a document from the sidebar to view it here.</p>
            </div>
            <div id="pdf-viewer"></div>
        </main>
    </div>


    <script>
        // Function to load and render a PDF
        function loadPDF(pdfPath) {
            const url = "{{ url_for('static', filename='pdffile') }}/" + pdfPath;

            document.getElementById('welcome-message').style.display = 'none';
            document.getElementById('pdf-viewer').innerHTML = '';

            pdfjsLib.getDocument(url).promise.then(pdf => {
                // Loop through each page in the PDF and render it
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    pdf.getPage(pageNum).then(page => {
                        const scale = 1.0;
                        const viewport = page.getViewport({ scale: scale });

                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        document.getElementById('pdf-viewer').appendChild(canvas);

                        page.render({
                            canvasContext: context,
                            viewport: viewport
                        });
                    });
                }
            });
        }

        function performAction(action, folderName = null, pdfName = null) {
            if (action === 'addFolder') {
                addFolder(deptName);
            } else if (action === 'addPDF') {
                addPDF(folderName);
            } else if (action === 'editFolder') {
                editFolderPrompt(folderName);
            } else if (action === 'deleteFolder') {
                deleteFolder(folderName);
            } else if (action === 'deletePDF') {
                deletePDF(folderName, pdfName);
            }
        }

        function addFolder(deptName) {
            const folderName = prompt("Enter the name of the new folder:");

            if (folderName && deptName) {
                fetch('/add_folder', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ folderName, deptName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload the page to show the new folder
                    } else {
                        alert(data.error);
                    }
                });
            } else {
                alert("Folder name and department name are required.");
            }
        }

        function addPDF(folderName) {
            const pdfFileInput = document.createElement("input");
            pdfFileInput.type = "file";
            pdfFileInput.accept = ".pdf";
            pdfFileInput.onchange = () => {
                const file = pdfFileInput.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append("pdfFile", file);
                    formData.append("folder", folderName);

                    fetch('/upload_pdf', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("PDF uploaded successfully!");
                            location.reload();  // Reload the page to show the new PDF
                        } else {
                            alert("Error: " + data.error);
                        }
                    });
                }
            };
            pdfFileInput.click();
        }

        function editFolderPrompt(folderName, deptName) {
            const newFolderName = prompt("Enter the new name for the folder:", folderName);
            if (newFolderName && newFolderName !== folderName) {
                fetch('/edit_folder', {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ oldFolderName: folderName, newFolderName: newFolderName, deptName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Folder name updated successfully.");
                        location.reload();
                    } else {
                        alert("Error: " + data.error);
                    }
                });
            }
        }

        function deleteFolder(folderName, deptName) {
            if (confirm(`Are you sure you want to delete folder "${folderName}"? This action cannot be undone.`)) {
                if (deptName) {
                    fetch('/delete_folder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folderName, deptName })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("Folder deleted successfully!");
                            location.reload();
                        } else {
                            alert(data.error);
                        }
                    });
                }
            }
        }

        function deletePDF(folderName, pdfName) {
            if (confirm(`Are you sure you want to delete the PDF "${pdfName}" from folder "${folderName}"? This action cannot be undone.`)) {
                fetch('/delete_pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folderName, pdfName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("PDF deleted successfully!");
                        location.reload();
                    } else {
                        alert(data.error);
                    }
                });
            }
        }

    </script>
</body>
</html>
