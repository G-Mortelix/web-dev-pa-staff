<!DOCTYPE html>
<html lang="en">
<head>
    <title>Internal Website Pro Amity Corporate Sdn Bhd</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style/styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
    </script>
</head>
<body>
    <header>
        <img src="{{ url_for('static', filename='icons/proamity-logo.png') }}" alt="Company Logo" class="logo">
        <h1>Library</h1>
        <a href="{{ url_for('logout') }}" class="logout-button">Logout</a>
        {% if current_user.role_id == 1 %}
            <a href="{{ url_for('admin_dashboard') }}" class="dashboard-button">Admin Dashboard</a>
        {% endif %}
    </header>

    <div class="container">
        <aside class="sidebar">
            {% if current_user.role_id == 1 %}
                <div class="management-controls">
                    <button onclick="addFolder()">Add Folder</button>
                    <button onclick="showUploadForm()">Add PDF</button>
                </div>
            {% endif %}

            {% for folder, pdffile in pdf_structure.items() %}
                <h2>
                    {{ folder }}
                    {% if current_user.role_id == 1 %}
                        <button onclick="deleteFolder('{{ folder }}')">üóëÔ∏è</button>
                    {% endif %}
                </h2>
                <ul>
                    {% for pdf in pdffile %}
                        <li>
                            <a href="#" onclick="loadPDF('{{ folder }}/{{ pdf }}'); return false;">{{ pdf }}</a>
                            {% if current_user.role_id == 1 %}
                                <button onclick="deletePDF('{{ folder }}', '{{ pdf }}')">üóëÔ∏è</button>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% endfor %}
        </aside>

        <div id="upload-pdf-form" style="display: none;">
            <h3>Upload a PDF</h3>
            <form id="pdfUploadForm" enctype="multipart/form-data">
                <label for="folderSelect">Select Folder:</label>
                <select id="folderSelect" name="folder">
                    {% for folder in pdf_structure.keys() %}
                        <option value="{{ folder }}">{{ folder | replace("_", " ") | capitalize }}</option>
                    {% endfor %}
                </select>
                <label for="pdfFile">Choose PDF:</label>
                <input type="file" id="pdfFile" name="pdfFile" accept=".pdf" required>
                <button type="button" onclick="uploadPDF()">Upload PDF</button>
                <button type="button" onclick="hideUploadForm()">Cancel</button>
            </form>
        </div>

        <main class="pdf-viewer-container">
            <div id="welcome-message">
                <h2>Welcome to Pro Amity Corporate Internal Website</h2>
                <p>Select a document from the sidebar to view it here.</p>
            </div>
            <div id="pdf-viewer"></div>
        </main>
    </div>

    <script>
        // Function to load and render a PDF
        function loadPDF(pdfPath) {
            const url = "{{ url_for('static', filename='pdffile') }}/" + pdfPath;

            document.getElementById('welcome-message').style.display = 'none';
            document.getElementById('pdf-viewer').innerHTML = '';

            pdfjsLib.getDocument(url).promise.then(pdf => {
                // Loop through each page in the PDF and render it
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    pdf.getPage(pageNum).then(page => {
                        const scale = 1.0;
                        const viewport = page.getViewport({ scale: scale });

                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        document.getElementById('pdf-viewer').appendChild(canvas);

                        page.render({
                            canvasContext: context,
                            viewport: viewport
                        });
                    });
                }
            });
        }

        function performAction(action) {
            if (action === 'addFolder') {
                addFolder();
            } else if (action === 'addPDF') {
                uploadPDF();
            } else if (action === 'deleteFolder') {
                deleteFolder();
            } else if (action === 'deletePDF') {
                deletePDF();
            }
        }
    
        function addFolder() {
            const folderName = prompt("Enter the name of the new folder:");
            const deptName = prompt("Enter the department name for the new folder:");

            if (folderName && deptName) {
                fetch('/add_folder', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ folderName, deptName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload the page to show the new folder
                    } else {
                        alert(data.error);
                    }
                });
            } else {
                alert("Folder name and department name are required.");
            }
        }
    
        function deleteFolder(folderName) {
            const deptName = prompt("Enter the department name of the folder:");
            if (deptName) {
                fetch('/delete_folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folderName: folderName, deptName: deptName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Folder deleted successfully!");
                        location.reload();
                    } else {
                        alert(data.error);
                    }
                });
            }
        }
    
        function deletePDF(folderName, pdfName) {
            fetch('/delete_pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folderName: folderName, pdfName: pdfName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("PDF deleted successfully!");
                    location.reload();
                } else {
                    alert(data.error);
                }
            });
        }

        // Show the upload form
        function showUploadForm() {
            document.getElementById('upload-pdf-form').style.display = 'block';
        }
    
        // Hide the upload form
        function hideUploadForm() {
            document.getElementById('upload-pdf-form').style.display = 'none';
        }
    
        // Upload PDF function
        function uploadPDF() {
            const formData = new FormData(document.getElementById('pdfUploadForm'));
            
            fetch('/upload_pdf', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("PDF uploaded successfully!");
                    location.reload();  // Reload the page to show the new PDF
                } else {
                    alert("Error: " + data.error);
                }
            });
        }
    </script>
</body>
</html>
